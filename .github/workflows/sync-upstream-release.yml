name: Sync Upstream Release

on:
  repository_dispatch:
    types: [sync-upstream]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check and sync
        run: |
          # Get upstream release
          upstream=$(curl -s https://api.github.com/repos/Tokisaki-Galaxy/webauthn-helper/releases/latest)
          upstream_tag=$(echo "$upstream" | jq -r '.tag_name')
          upstream_body=$(echo "$upstream" | jq -r '.body')
          
          # Get current release
          current_tag=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
          
          echo "Upstream: $upstream_tag"
          echo "Current: $current_tag"
          
          # Check if update needed
          if [ "$upstream_tag" = "$current_tag" ]; then
            echo "Already up to date"
            exit 0
          fi
          
          echo "New release detected: $upstream_tag"
          
          # Update Makefile
          cd openwrt-webauthn-helper/
          chmod +x ./update.sh
          bash ./update.sh
          
          # Commit changes
          git config user.name "GitHub Action"
          git config user.email "actions-user@users.noreply.github.com"
          git add .
          git diff-index --cached --quiet HEAD || git commit -m "Update to $upstream_tag"
          git push
          
          # Trigger build
          upstream_body_encoded=$(echo "$upstream_body" | base64 | tr -d '\n')
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT || secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\":\"upstream-release\",\"client_payload\":{\"upstream_tag\":\"$upstream_tag\",\"upstream_body\":\"$upstream_body_encoded\"}}"

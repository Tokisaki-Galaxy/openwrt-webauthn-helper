name: Version check (Legacy)

on:
  workflow_dispatch:
  schedule:
  - cron: "0 5 * * 5"

jobs:
  deploy:
    name: Version check
    runs-on: ubuntu-latest
    permissions:
      contents: write  # To push a branch
    steps:
    - uses: actions/checkout@v6

    - name: Init repo
      shell: bash
      run: |
        git config --local user.name "GitHub Action"
        git config --local user.email "actions-user@users.noreply.github.com"

    - name: Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      shell: bash
      run: |
        sudo apt update
        sudo apt -y install curl jq

    - name: Check and update version
      id: update
      shell: bash
      run: |
        cd openwrt-webauthn-helper/
        # Store old version before update
        OLD_VERSION=$(sed -n 's|RUST_WEBAUTHN_HELPER_VERSION:=||p' ./Makefile)
        echo "Old version: $OLD_VERSION"
        
        chmod +x ./update.sh
        bash ./update.sh
        
        # Check new version after update
        NEW_VERSION=$(sed -n 's|RUST_WEBAUTHN_HELPER_VERSION:=||p' ./Makefile)
        echo "New version: $NEW_VERSION"
        
        if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
          echo "version_changed=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        else
          echo "version_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push files
      if: steps.update.outputs.version_changed == 'true'
      shell: bash
      run: |
        cd openwrt-webauthn-helper/
        git add .
        git commit -m "Update webauthn-helper to version ${{ steps.update.outputs.new_version }}"
        git push

    - name: Trigger build workflow
      if: steps.update.outputs.version_changed == 'true'
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
        event-type: upstream-release
